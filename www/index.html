<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MAVLink Ground Station</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/index.css">

</head>
<body>
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="auth-tab">🔐 Авторизация</button>
            <button class="tab-btn" data-tab="params-tab">⚙️ Параметры</button>
            <button class="tab-btn" data-tab="map-tab">🗺️ Карта</button>
            <button class="tab-btn" data-tab="log-tab">📋 Лог</button>
        </div>

        <div id="auth-tab" class="tab-content active">
            <div class="auth-container">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Авторизация в системе</h2>
                <div class="auth-form">
                    <div class="form-group">
                        <label class="form-label">Логин</label>
                        <input type="text" class="form-input" placeholder="Введите ваш логин" id="login-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" class="form-input" placeholder="Введите ваш пароль" id="password-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Сервер</label>
                        <input type="text" class="form-input" placeholder="Адрес сервера" value="localhost:14550" id="server-input">
                    </div>
                    <button class="btn btn-block" id="login-btn">Войти в систему</button>
                </div>
                <div style="text-align: center; margin-top: 20px; color: #666;">
                    <small>Версия 1.0.0 | MAVLink Ground Station</small>
                </div>
            </div>
        </div>

        <div id="params-tab" class="tab-content">
            <div class="params-container">
                <h2 style="margin-bottom: 20px; color: #333;">Параметры системы</h2>
                <div class="params-grid">
                    <div class="param-group">
                        <div class="param-title">📡 GPS параметры</div>
                        <div class="param-item">
                            <span class="param-label">Широта</span>
                            <span class="param-value" id="param-lat">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Долгота</span>
                            <span class="param-value" id="param-lon">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Высота</span>
                            <span class="param-value" id="param-alt">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Спутники</span>
                            <span class="param-value" id="param-sats">--</span>
                        </div>
                    </div>

                    <div class="param-group">
                        <div class="param-title">🚁 Полетные параметры</div>
                        <div class="param-item">
                            <span class="param-label">Скорость</span>
                            <span class="param-value" id="param-speed">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Крен</span>
                            <span class="param-value" id="param-roll">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Тангаж</span>
                            <span class="param-value" id="param-pitch">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Рыскание</span>
                            <span class="param-value" id="param-yaw">--</span>
                        </div>
                    </div>

                    <div class="param-group">
                        <div class="param-title">🔋 Системные параметры</div>
                        <div class="param-item">
                            <span class="param-label">Батарея</span>
                            <span class="param-value" id="param-battery">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Напряжение</span>
                            <span class="param-value" id="param-voltage">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Ток</span>
                            <span class="param-value" id="param-current">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Режим полета</span>
                            <span class="param-value" id="param-mode">--</span>
                        </div>
                    </div>

                    <div class="param-group">
                        <div class="param-title">📍 Позиции</div>
                        <div class="param-item">
                            <span class="param-label">Мое местоположение</span>
                            <span class="param-value" id="param-my-pos">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Позиция квадрокоптера</span>
                            <span class="param-value" id="param-drone-pos">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Расстояние до дрона</span>
                            <span class="param-value" id="param-distance">--</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Направление</span>
                            <span class="param-value" id="param-direction">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="map-tab" class="tab-content">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-btn" onclick="centerOnDrone()">Центрировать на дроне</button>
                    <button class="map-btn" onclick="centerOnUser()">Центрировать на мне</button>
                    <button class="map-btn" onclick="toggleFollowDrone()">Следовать за дроном: Выкл</button>
                    <button class="map-btn" onclick="clearTrack()">Очистить трек</button>
                </div>
            </div>
        </div>

        <div id="log-tab" class="tab-content">
            <div class="log-container">
                <h2 style="margin-bottom: 15px; color: #333;">Журнал событий</h2>
                <div class="log-controls">
                    <button class="btn" onclick="clearLog()">Очистить лог</button>
                    <button class="btn" onclick="exportLog()">Экспорт</button>
                    <button class="btn" onclick="toggleAutoScroll()">Автопрокрутка: Вкл</button>
                </div>
                <div class="log-content" id="log-content">
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="cordova.js"></script>
    <script src="js/mavlink-browser20.js"></script>
    <script src="js/mavlink.js"></script>
    <script src="js/udp.js"></script>
    <script>
        class MAVLinkApp {
            constructor() {
                this.currentTab = 'auth-tab';
                this.map = null;
                this.userMarker = null;
                this.droneMarker = null;
                this.userPosition = null;
                this.dronePosition = null;
                this.trackLayer = null;
                this.followDrone = false;
                this.autoScroll = true;

                this.isCordova = typeof window.cordova !== 'undefined';

                this.init();
            }

            init() {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.tab);
                    });
                });

                document.getElementById('login-btn').addEventListener('click', () => {
                    this.handleLogin();
                });

                this.loadSavedData();
                this.initMap();
                this.getUserLocation();
                this.startMAVLinkConnection();
                // Cordova специфичные настройки
                if (this.isCordova) {
                    this.setupCordovaEvents();
                }
            }

            setupCordovaEvents() {
                // Пауза при сворачивании приложения
                document.addEventListener('pause', () => {
                    this.addLog('Приложение свернуто', 'warning');
                    this.pauseMAVLinkConnection();
                }, false);

                // Возобновление при разворачивании
                document.addEventListener('resume', () => {
                    this.addLog('Приложение восстановлено', 'success');
                    this.resumeMAVLinkConnection();
                }, false);

                // Кнопка назад на Android
                document.addEventListener('backbutton', () => {
                    this.handleBackButton();
                }, false);
            }

            handleBackButton() {
                // Выход из приложения при двойном нажатии назад
                if (this.currentTab === 'map-tab') {
                    navigator.app.exitApp();
                } else {
                    this.switchTab('map-tab');
                }
            }

            initMap() {
                if (typeof L === "undefined") {
                    this.addLog('Map is not loaded', 'error');
                    return;
                }
                this.map = L.map('map').setView([55.7558, 37.6173], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.map);

                this.trackLayer = L.layerGroup().addTo(this.map);

                this.addLog('Карта инициализирована', 'success');
            }

            getUserLocation() {
                if (this.isCordova) {
                    // Используем Cordova Geolocation API
                    this.getCordovaLocation();
                } else {
                    // Используем браузерный API
                    this.getBrowserLocation();
                }
            }

            getCordovaLocation() {
                const onSuccess = (position) => {
                    this.userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    this.updateUserMarker();
                    this.addLog('Местоположение получено через Cordova', 'success');
                };

                const onError = (error) => {
                    this.addLog('Ошибка геолокации: ' + error.message, 'error');
                    // Резервная позиция
                    this.userPosition = { lat: 55.7558, lng: 37.6173 };
                    this.updateUserMarker();
                };

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                };

                navigator.geolocation.getCurrentPosition(onSuccess, onError, options);

                // Следим за изменениями позиции
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        this.updateUserMarker();
                    },
                    onError,
                    options
                );
            }

            getBrowserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.userPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            this.updateUserMarker();
                            this.addLog('Местоположение получено', 'success');
                        },
                        (error) => {
                            this.addLog('Ошибка геолокации: ' + error.message, 'error');
                            this.userPosition = { lat: 55.7558, lng: 37.6173 };
                            this.updateUserMarker();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                }
            }

            updateUserMarker() {
                if (!this.userPosition || typeof L === "undefined") return;

                if (!this.userMarker) {
                    this.userMarker = L.marker([this.userPosition.lat, this.userPosition.lng], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: '👤',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(this.map);

                    this.userMarker.bindPopup("<b>Ваше местоположение</b>").openPopup();
                } else {
                    this.userMarker.setLatLng([this.userPosition.lat, this.userPosition.lng]);
                }

                this.updateUserPositionDisplay();
            }


            updateDronePosition(lat, lng) {
                this.dronePosition = { lat, lng };
                if (typeof L === "undefined") return;

                if (!this.droneMarker) {
                    this.droneMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'drone-marker',
                            html: '🚁',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(this.map);

                    this.droneMarker.bindPopup("<b>Квадрокоптер</b>");
                } else {
                    this.droneMarker.setLatLng([lat, lng]);
                }

                L.circleMarker([lat, lng], {
                    radius: 2,
                    color: '#ff4444',
                    fillColor: '#ff4444',
                    fillOpacity: 0.7
                }).addTo(this.trackLayer);

                if (this.followDrone) {
                    this.map.setView([lat, lng], this.map.getZoom());
                }

                this.updateDronePositionDisplay();
                this.calculateDistance();
            }

            updateUserPositionDisplay() {
                if (this.userPosition) {
                    document.getElementById('param-my-pos').textContent =
                        `${this.userPosition.lat.toFixed(6)}, ${this.userPosition.lng.toFixed(6)}`;
                }
            }

            updateDronePositionDisplay() {
                if (this.dronePosition) {
                    document.getElementById('param-drone-pos').textContent =
                        `${this.dronePosition.lat.toFixed(6)}, ${this.dronePosition.lng.toFixed(6)}`;
                }
            }

            calculateDistance() {
                if (this.userPosition && this.dronePosition) {
                    const R = 6371;
                    const dLat = (this.dronePosition.lat - this.userPosition.lat) * Math.PI / 180;
                    const dLon = (this.dronePosition.lng - this.userPosition.lng) * Math.PI / 180;
                    const a =
                        Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(this.userPosition.lat * Math.PI / 180) * Math.cos(this.dronePosition.lat * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const distance = R * c;

                    document.getElementById('param-distance').textContent = distance.toFixed(2) + ' км';

                    const y = Math.sin(dLon) * Math.cos(this.dronePosition.lat * Math.PI / 180);
                    const x = Math.cos(this.userPosition.lat * Math.PI / 180) * Math.sin(this.dronePosition.lat * Math.PI / 180) -
                              Math.sin(this.userPosition.lat * Math.PI / 180) * Math.cos(this.dronePosition.lat * Math.PI / 180) * Math.cos(dLon);
                    const bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;

                    const directions = ['С', 'СВ', 'В', 'ЮВ', 'Ю', 'ЮЗ', 'З', 'СЗ'];
                    const index = Math.round(bearing / 45) % 8;
                    document.getElementById('param-direction').textContent = directions[index] + ` (${Math.round(bearing)}°)`;
                }
            }

            startMAVLinkConnection() {
                this.initUDPConnection();
                this.startUIUpdateLoop();
            }

            initUDPConnection() {
                startUDPListener();
            }

            pauseMAVLinkConnection() {
                // Приостановка UDP соединения при паузе
                stopUDPListener();
            }

            resumeMAVLinkConnection() {
                // Восстановление UDP соединения
                startUDPListener();
            }

            startUIUpdateLoop() {
                setInterval(() => {
                    updateUIData();
                    this.renderUI();
                }, 100);
            }

            renderUI() {
                const data = getUIData();
                this.updateDronePosition(data.lat ?? 0, data.lon ?? 0);

                updateElement('param-lat', data.lat, v => (v / 1e7).toFixed(6));
                updateElement('param-lon', data.lon, v => (v / 1e7).toFixed(6));
                updateElement('param-alt', data.alt, v => (v / 1e3).toFixed(1));
                updateElement("param-sats", data.satellites_visible);
                updateElement("param-speed", data.vel, v => (v / 1e2).toFixed(1) + ' m/s');

                updateElement("param-yaw", data.yaw, v => radiansToDegrees(v).toFixed(0) + '°');
                updateElement("param-pitch", data.pitch, v => radiansToDegrees(v).toFixed(1) + '°');
                updateElement("param-roll", data.roll, v => radiansToDegrees(v).toFixed(1) + '°');

//              document.getElementById('param-mode').textContent = mockData.mode;

//              updateElement("fixType", data.fix_type, getGPSFixType);
//              updateElement("craftType", data.type, getMAVTypeName);

                updateElement("param-voltage", data.voltage_battery, v => (v / 1e3).toFixed(1) + 'V');
                updateElement("param-current", data.current_battery, v => (v / 1e2).toFixed(1) + 'A');
                updateElement("param-battery", data.battery_remaining, v => v  + '%');
            }

            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                document.getElementById(tabId).classList.add('active');
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

                this.currentTab = tabId;
                this.onTabChange(tabId);
            }

            onTabChange(tabId) {
                switch(tabId) {
                    case 'map-tab':
                        setTimeout(() => {
                            if (this.map) {
                                this.map.invalidateSize();
                            }
                        }, 100);
                        break;
                    case 'params-tab':
                        this.renderUI();
                        break;
                }
            }

            handleLogin() {
                const login = document.getElementById('login-input').value;
                const password = document.getElementById('password-input').value;
                const server = document.getElementById('server-input').value;

                if (!login || !password) {
                    this.addLog('Ошибка: Заполните все поля', 'error');
                    return;
                }

                this.addLog(`Попытка авторизации: ${login}@${server}`, 'info');

                localStorage.setItem('mavlink-login', login);
                localStorage.setItem('mavlink-server', server);

                setTimeout(() => {
                    this.addLog('Авторизация успешна!', 'success');
                    this.addLog('Подключение к БПЛА...', 'info');

                    setTimeout(() => {
                        this.switchTab('map-tab');
                    }, 1000);
                }, 1500);
            }

            addLog(message, type = 'info') {
                const logContent = document.getElementById('log-content');
                logMessage(message, type);

                if (this.autoScroll) {
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }

            loadSavedData() {
                const savedLogin = localStorage.getItem('mavlink-login');
                const savedServer = localStorage.getItem('mavlink-server');

                if (savedLogin) {
                    document.getElementById('login-input').value = savedLogin;
                }
                if (savedServer) {
                    document.getElementById('server-input').value = savedServer;
                }
            }
        }

        function centerOnDrone() {
            if (window.app.dronePosition && window.app.map) {
                window.app.map.setView([window.app.dronePosition.lat, window.app.dronePosition.lng]);
                window.app.addLog('Карта отцентрирована на квадрокоптере', 'info');
            }
        }

        function centerOnUser() {
            if (window.app.userPosition && window.app.map) {
                window.app.map.setView([window.app.userPosition.lat, window.app.userPosition.lng]);
                window.app.addLog('Карта отцентрирована на вашем местоположении', 'info');
            }
        }

        function toggleFollowDrone() {
            window.app.followDrone = !window.app.followDrone;
            const btn = document.querySelector('[onclick="toggleFollowDrone()"]');
            btn.textContent = `Следовать за дроном: ${window.app.followDrone ? 'Вкл' : 'Выкл'}`;
            window.app.addLog(`Следование за дроном: ${window.app.followDrone ? 'включено' : 'выключено'}`, 'info');
        }

        function clearTrack() {
            if (window.app.trackLayer) {
                window.app.trackLayer.clearLayers();
                window.app.addLog('Трек полета очищен', 'warning');
            }
        }

        function clearLog() {
            document.getElementById('log-content').innerHTML = '';
            window.app.addLog('Журнал очищен', 'warning');
        }

        function exportLog() {
            window.app.addLog('Экспорт журнала...', 'info');
        }

        function toggleAutoScroll() {
            window.app.autoScroll = !window.app.autoScroll;
            const btn = document.querySelector('[onclick="toggleAutoScroll()"]');
            btn.textContent = `Автопрокрутка: ${window.app.autoScroll ? 'Вкл' : 'Выкл'}`;
            window.app.addLog(`Автопрокрутка: ${window.app.autoScroll ? 'включена' : 'выключена'}`, 'info');
        }

        function logMessage(message, type = 'info') {
            const logContent = document.getElementById('log-content');
                const timestamp = new Date().toLocaleString('ru-RU');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-${type}">${message}</span>
                `;

                logContent.appendChild(logEntry);
            console.log(message);
        }

        function updateElement(elementId, value, formatter = null) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if(typeof value === 'function') {
                element.textContent = value();
            } else if (value != null && value !== undefined) {
                element.textContent = formatter ? formatter(value) : value;
            } else {
                element.textContent = '--';
            }
        }

        document.addEventListener('deviceready', () => {
            window.app = new MAVLinkApp();
            window.app.addLog('Cordova device ready', 'success');
            //checkPermissions();
        }, false);

    function checkPermissions() {
        const permissions = cordova.plugins.permissions;

        // Список необходимых разрешений
        const permissionList = [
            permissions.ACCESS_FINE_LOCATION,
            permissions.ACCESS_COARSE_LOCATION,
            permissions.ACCESS_BACKGROUND_LOCATION
        ];

        permissions.hasPermission(permissionList, function(status) {
            if (!status.hasPermission) {
                // Запрашиваем разрешения
                permissions.requestPermissions(permissionList, function(result) {
                    if (result.hasPermission) {
                        console.log("Все разрешения получены");
                        startGeolocation();
                    } else {
                        console.log("Пользователь отказал в разрешениях");
                        alert("Для работы приложения необходимы разрешения на доступ к местоположению");
                    }
                }, function(error) {
                    console.log("Ошибка при запросе разрешений: ", error);
                });
            } else {
                console.log("Все разрешения уже предоставлены");
                startGeolocation();
            }
        });
    }

/*
    document.addEventListener('DOMContentLoaded', () => {
        window.app = new MAVLinkApp();
    });
*/

    // Для отладки в браузере
    if (typeof cordova === 'undefined') {
        window.app = new MAVLinkApp();
}
    </script>
</body>
</html>